<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Pintar - Aplikasi Pencatat Notulen Powered by Llama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link rel="icon" href="/path/to/favicon.ico">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .inline-loader { display: inline-block; vertical-align: middle; width: 16px; height: 16px; border-width: 2px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-backdrop { background-color: rgba(0,0,0,0.6); }
        .btn-spinner { border-top-color: white !important; width: 20px !important; height: 20px !important; }
        .photo-container { position: relative; }
        .delete-photo-btn {
            position: absolute; top: -4px; right: -4px;
            background-color: rgba(239, 68, 68, 0.9); color: white;
            border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            border: 1px solid white; line-height: 1;
        }
        .warning-box {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .warning-text {
            color: #92400e;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto p-6 md:p-8 max-w-6xl bg-white rounded-2xl shadow-2xl border border-slate-200">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Asisten Pintar</h1>
            <p class="text-slate-600 mt-2">Aplikasi Pencatat Notulen Powered by Llama</p>
            <div class="mt-4 flex justify-center items-center space-x-4 text-sm">
                <a href="https://asistenpintarku.isparmo.com/about.html" target="_blank" class="font-semibold text-indigo-600 hover:underline">Tentang Aplikasi</a>
                <span class="text-slate-400">|</span>
                <a href="https://asistenpintarku.isparmo.com/help.html" target="_blank" class="font-semibold text-indigo-600 hover:underline">Bantuan</a>
            </div>
        </header>

        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Informasi Acara</h2>
            <div id="event-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="text" id="meetingName" placeholder="Nama Acara" class="p-2 border border-slate-300 rounded-lg">
                <select id="summaryTheme" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="meeting">Rapat</option>
                    <option value="lecture">Kelas / Kuliah</option>
                    <option value="seminar">Seminar</option>
                    <option value="discussion">Diskusi</option>
                    <option value="interview">Wawancara</option>
                    <option value="sermon">Kajian / Ceramah</option>
                    <option value="consultation">Sesi Konsultasi</option>
                    <option value="ideation">Pencatat Ide</option>
                </select>
                <input type="text" id="speakerName" placeholder="Pembicara (jika ada)" class="p-2 border border-slate-300 rounded-lg">
                <input type="date" id="meetingDate" class="p-2 border border-slate-300 rounded-lg w-full">
                <input type="time" id="meetingTime" class="p-2 border border-slate-300 rounded-lg w-full">
                <input type="text" id="meetingPlace" placeholder="Tempat" class="p-2 border border-slate-300 rounded-lg">
                <textarea id="meetingNotes" placeholder="Catatan Tambahan..." class="p-2 border border-slate-300 rounded-lg md:col-span-3" rows="1"></textarea>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                 <h3 class="text-lg font-semibold mb-2 text-slate-700">Dokumentasi Foto</h3>
                 <div class="flex flex-col sm:flex-row gap-2 mb-2">
                     <button id="takeDocPhotoButton" class="flex-1 bg-blue-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-600">Ambil Foto</button>
                     <button id="takeDocScreenshotAreaButton" class="flex-1 bg-cyan-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-cyan-600">Ambil Screenshot</button>
                     <label class="flex-1 bg-blue-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-600 text-center cursor-pointer">Upload Foto<input type="file" id="uploadDocPhoto" class="hidden" accept="image/*" multiple></label>
                 </div>
                 <div id="doc-photos-preview" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">1. Kumpulkan Catatan</h2>
                <div class="space-y-4">
                    <div class="border-b border-slate-200 pb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Pilih Sumber Suara:</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2">
                            <label class="flex items-center"><input type="radio" name="audioSource" value="mic" class="mr-2" checked> Mikrofon</label>
                            <label id="audioSourceSpeakerLabel" class="flex items-center"><input type="radio" name="audioSource" value="speaker" class="mr-2"> Speaker (Audio Sistem)</label>
                            <label id="audioSourceBothLabel" class="flex items-center"><input type="radio" name="audioSource" value="both" class="mr-2"> Keduanya</label>
                        </div>
                        
                        <div id="speakerWarning" class="warning-box hidden mt-3">
                            <div class="warning-text">
                                <strong>‚ö†Ô∏è Penting untuk Perekaman Audio Sistem:</strong><br>
                                1. Saat dialog izin muncul, pastikan Anda memilih tab/jendela yang sedang memutar audio (misalnya Zoom)<br>
                                2. <strong>WAJIB centang kotak "Share system audio" atau "Bagikan audio tab"</strong><br>
                                3. Jika tidak ada opsi audio, coba tutup dialog dan pilih tab yang berbeda<br>
                                4. Beberapa browser mungkin meminta izin mikrofon terlebih dahulu - ini normal
                            </div>
                        </div>
                    </div>
                    <button id="recordButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center space-x-2 shadow-sm">
                        <span>Mulai Rekam Suara</span>
                    </button>
                    <div id="recording-indicator" class="text-center text-sm font-mono text-slate-700 hidden">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="loader inline-loader !border-t-red-500"></div>
                            <span>Durasi Sesi: <span id="timer">00:00</span></span>
                        </div>
                    </div>
                    <div id="audio-chunks-list" class="mt-2 space-y-2 text-sm"></div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="takeScreenshotButton" class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700">Ambil Foto</button>
                        <button id="takeNoteScreenshotAreaButton" class="flex-1 bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700">Ambil Screenshot</button>
                        <label class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 text-center cursor-pointer">
                            <span>Upload Screenshot</span>
                            <input type="file" id="uploadScreenshot" class="hidden" accept="image/*" multiple>
                        </label>
                    </div>
                     <div id="screenshot-photos-preview" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
                    <div class="border-t border-slate-200 pt-4">
                        <textarea id="manualNote" class="w-full p-3 border border-slate-300 rounded-lg" rows="3" placeholder="Atau ketik catatan manual di sini..."></textarea>
                        <button id="addNoteButton" class="w-full mt-2 bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-700">Tambah Catatan Manual</button>
                    </div>
                </div>
                 <div class="mt-auto pt-4 text-center text-sm text-slate-600 h-5 flex items-center justify-center space-x-2">
                    <div id="status-loader" class="loader !w-4 !h-4 !border-2 hidden"></div>
                    <span id="status">Siap Merekam...</span>
                </div>
            </div>

            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">2. Gabungan Transkrip</h2>
                <div id="transcriptOutput" class="h-80 overflow-y-auto bg-white p-4 rounded-lg border border-slate-200 text-sm leading-relaxed flex-grow">
                    <p class="text-slate-400">Catatan dari suara, gambar, dan ketikan akan muncul di sini.</p>
                </div>
            </div>
        </div>

        <div class="text-center mb-6">
            <button id="summarizeButton" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 flex items-center justify-center space-x-3 disabled:bg-slate-400 disabled:cursor-not-allowed shadow-lg mx-auto" disabled>
                <span>Buat Ringkasan</span>
                <div id="summarizeLoader" class="loader hidden"></div>
            </button>
        </div>
        <div>
            <h2 class="text-2xl font-semibold mb-4 text-center text-slate-800">3. Hasil Ringkasan</h2>
            <div id="summaryOutput" class="bg-white p-6 rounded-xl border border-slate-200 min-h-[200px] prose max-w-none prose-headings:text-slate-700 prose-strong:text-slate-800">
                <p class="text-slate-500">Ringkasan akan muncul di sini.</p>
            </div>
        </div>
        
        <div id="saveOptions" class="mt-8 grid grid-cols-1 justify-center hidden">
            <div class="text-center bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h2 class="text-xl font-semibold mb-2 text-slate-800">Simpan Laporan</h2>
                <div class="flex justify-center items-center gap-4 flex-wrap">
                    <button id="downloadTxt" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan .txt</span></button>
                    <button id="downloadMd" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan .md</span></button>
                    <button id="printButton" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Cetak Laporan (.pdf)</span></button>
                    <button id="downloadAudio" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan Audio Lengkap</span></button>
                    <button id="downloadPhotos" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan Foto (.zip)</span></button>
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <div class="flex justify-end items-center mb-2 h-9">
                <button id="toggleLogButton" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Tampilkan/Sembunyikan Log Developer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-slate-600" viewBox="0 0 16 16">
                        <path d="M6 9a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 9zM3.854 4.146a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2z"/>
                        <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2zm12 1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h12z"/>
                    </svg>
                </button>
            </div>
            <div id="logWrapper" class="hidden">
                 <div id="logContainer" class="bg-slate-800 text-white font-mono text-xs p-4 rounded-lg h-40 overflow-y-auto mb-2"></div>
                 <button id="copyLogButton" class="bg-slate-200 text-slate-600 text-xs font-semibold py-1 px-3 rounded-md hover:bg-slate-300">Copy Log</button>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-sm text-slate-500 space-y-2">
            <div class="flex justify-center items-center space-x-4">
                <a href="https://asistenpintarku.isparmo.com/terms.html" target="_blank" class="hover:underline">Ketentuan Layanan</a>
                <span class="text-slate-400">|</span>
                <a href="https://asistenpintarku.isparmo.com/privacy.html" target="_blank" class="hover:underline">Kebijakan Privasi</a>
            </div>
            <p>Dibuat oleh <a href="https://github.com/masisparmo" target="_blank" class="font-semibold text-indigo-600 hover:underline">masisparmo</a> untuk Hackathon Meta-Hacktiv8 2025.</p>
        </footer>
    </div>

    <button id="newSessionButton" title="Mulai Sesi Baru" class="fixed bottom-6 right-6 bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
    </button>

    <div id="cameraModal" class="fixed inset-0 z-50 items-center justify-center hidden flex modal-backdrop">
        <div class="bg-white p-4 rounded-lg shadow-xl">
            <video id="camera-stream" class="rounded-md" autoplay playsinline></video>
            <button id="captureButton" class="w-full mt-4 bg-red-600 text-white font-bold py-2 rounded-lg">Ambil Gambar</button>
        </div>
    </div>
    
    <div id="instructionModal" class="fixed inset-0 z-50 items-center justify-center hidden flex modal-backdrop">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-bold text-slate-800 mb-3">üì∏ Petunjuk Pengambilan Screenshot & Audio</h3>
            <div class="text-sm text-slate-600 mb-4 space-y-3">
                <p><strong>Langkah 1:</strong> Browser akan meminta izin untuk <strong>berbagi layar</strong>. Izin ini diperlukan untuk mengambil <strong>screenshot</strong> atau merekam <strong>audio sistem</strong>.</p>
                <p><strong>Langkah 2:</strong> Pilih tab, jendela, atau seluruh layar yang ingin Anda ambil gambarnya atau rekam audionya.</p>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                    <p class="font-semibold text-yellow-800">‚ö†Ô∏è KHUSUS AUDIO:</p>
                    <p class="text-yellow-700">Jika ingin merekam audio (misal dari Zoom), pastikan Anda <strong>mencentang kotak "Share system audio" atau "Bagikan audio tab"</strong>. Jika tidak, audio tidak akan terekam!</p>
                </div>
                <p><strong>Langkah 3:</strong> Klik "Share" atau "Bagikan" untuk melanjutkan.</p>
                <p class="text-xs text-slate-500"><em>Catatan: Setelah izin diberikan, aplikasi akan langsung mengambil screenshot atau memulai perekaman audio sesuai tombol yang Anda klik.</em></p>
            </div>
            <button id="instructionOkButton" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Saya Mengerti, Lanjutkan</button>
        </div>
    </div>

    <script type="module">
        // Ganti dengan URL Cloud Run Anda
        const BACKEND_URL = 'https://asisten-pintar-service-303231084056.asia-southeast1.run.app'; 

        // --- DOM Elements ---
        const newSessionButton = document.getElementById('newSessionButton');
        const recordButton = document.getElementById('recordButton');
        const uploadScreenshotInput = document.getElementById('uploadScreenshot');
        const manualNote = document.getElementById('manualNote');
        const addNoteButton = document.getElementById('addNoteButton');
        const summarizeButton = document.getElementById('summarizeButton');
        const statusSpan = document.getElementById('status');
        const statusLoader = document.getElementById('status-loader');
        const transcriptOutput = document.getElementById('transcriptOutput');
        const summaryOutput = document.getElementById('summaryOutput');
        const saveOptions = document.getElementById('saveOptions');
        const summarizeLoader = document.getElementById('summarizeLoader');
        const recordingIndicator = document.getElementById('recording-indicator');
        const timerSpan = document.getElementById('timer');
        const logContainer = document.getElementById('logContainer');
        const logWrapper = document.getElementById('logWrapper');
        const toggleLogButton = document.getElementById('toggleLogButton');
        const copyLogButton = document.getElementById('copyLogButton');
        const cameraModal = document.getElementById('cameraModal');
        const cameraStream = document.getElementById('camera-stream');
        const captureButton = document.getElementById('captureButton');
        const takeDocPhotoButton = document.getElementById('takeDocPhotoButton');
        const takeScreenshotButton = document.getElementById('takeScreenshotButton');
        const uploadDocPhotoInput = document.getElementById('uploadDocPhoto');
        const takeDocScreenshotAreaButton = document.getElementById('takeDocScreenshotAreaButton');
        const takeNoteScreenshotAreaButton = document.getElementById('takeNoteScreenshotAreaButton');
        const docPhotosPreview = document.getElementById('doc-photos-preview');
        const screenshotPhotosPreview = document.getElementById('screenshot-photos-preview');
        const downloadTxtBtn = document.getElementById('downloadTxt');
        const downloadMdBtn = document.getElementById('downloadMd');
        const printButton = document.getElementById('printButton');
        const downloadAudioBtn = document.getElementById('downloadAudio');
        const downloadPhotosBtn = document.getElementById('downloadPhotos');
        const speakerWarning = document.getElementById('speakerWarning');
        const audioChunksList = document.getElementById('audio-chunks-list');

        // --- State Variables ---
        let mediaRecorder, activeStream, audioChunks = [], allRecordedBlobs = [];
        let isContinuousRecording = false, chunkCount = 0, chunkTimer, timerInterval, totalSeconds = 0;
        let transcriptEmpty = true, fullTranscript = "", summaryText = "";
        let currentCameraCallback = null;
        let documentationImages = [], screenshotImages = [];
        const MAX_CHUNK_DURATION = 20 * 60 * 1000; // 20 menit

        // --- Utility Functions ---
        function log(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp} [${type}] ${message}`;
            console.log(logEntry);
            logContainer.innerHTML += `<div>${logEntry}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function saveState() {
            const state = {
                fullTranscript, summaryText, transcriptEmpty,
                documentationImages: documentationImages.map(img => ({ dataUrl: img.dataUrl, filename: img.filename, type: img.type })),
                screenshotImages: screenshotImages.map(img => ({ dataUrl: img.dataUrl, filename: img.filename, type: img.type })),
                eventForm: {
                    meetingName: document.getElementById('meetingName').value,
                    summaryTheme: document.getElementById('summaryTheme').value,
                    speakerName: document.getElementById('speakerName').value,
                    meetingDate: document.getElementById('meetingDate').value,
                    meetingTime: document.getElementById('meetingTime').value,
                    meetingPlace: document.getElementById('meetingPlace').value,
                    meetingNotes: document.getElementById('meetingNotes').value,
                }
            };
            localStorage.setItem('asistenPintarState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('asistenPintarState');
            if (saved) {
                const state = JSON.parse(saved);
                fullTranscript = state.fullTranscript || "";
                summaryText = state.summaryText || "";
                transcriptEmpty = state.transcriptEmpty !== false;
                
                if (fullTranscript) {
                    transcriptOutput.innerHTML = fullTranscript.split('---').map(part => part.trim()).filter(part => part).map(part => `<div class="mb-2 p-2 bg-slate-100 rounded">${part.replace(/\n/g, '<br>')}</div>`).join('');
                    summarizeButton.disabled = false;
                }
                
                if (summaryText) {
                    summaryOutput.innerHTML = markdownToHtml(summaryText);
                    saveOptions.classList.remove('hidden');
                }

                if (state.eventForm) {
                    Object.keys(state.eventForm).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) element.value = state.eventForm[key];
                    });
                }

                documentationImages = (state.documentationImages || []).map(img => ({ ...img, file: null }));
                screenshotImages = (state.screenshotImages || []).map(img => ({ ...img, file: null }));
                renderDocPhotos();
                renderScreenshotPhotos();
            }
        }

        function showInstructionModalAndWait() {
            return new Promise(resolve => {
                const modal = document.getElementById('instructionModal');
                const okButton = document.getElementById('instructionOkButton');
                modal.classList.remove('hidden');
                
                const newOkButton = okButton.cloneNode(true);
                okButton.parentNode.replaceChild(newOkButton, okButton);

                newOkButton.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    resolve();
                });
            });
        }

        async function ensurePermissions(constraints) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (err) {
                log(`Permission denied for ${JSON.stringify(constraints)}: ${err.message}`, 'ERROR');
                alert('Akses mikrofon ditolak. Harap aktifkan izin di pengaturan browser Anda untuk menggunakan fitur ini.');
                return false;
            }
        }
        
        async function getAudioStream() {
            log('Attempting to get audio stream...');
            const source = document.querySelector('input[name="audioSource"]:checked').value;
            let micStream, displayStream;

            try {
                if (source === 'mic') {
                    return await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                if (source === 'speaker' || source === 'both') {
                    await showInstructionModalAndWait();
                    
                    try {
                        displayStream = await navigator.mediaDevices.getDisplayMedia({ 
                            video: true, 
                            audio: {
                                echoCancellation: false,
                                noiseSuppression: false,
                                autoGainControl: false
                            }
                        });
                        
                        const audioTracks = displayStream.getAudioTracks();
                        if (audioTracks.length === 0) {
                            log('Tidak ada audio track yang tersedia dari display media. Pastikan Anda mencentang "Share system audio".', 'ERROR');
                            displayStream.getTracks().forEach(track => track.stop());
                            throw new Error('Tidak ada audio sistem yang tersedia. Pastikan Anda mencentang opsi "Share system audio" atau "Bagikan audio tab" saat memberikan izin.');
                        }
                        
                        log(`Audio track ditemukan: ${audioTracks.length} track(s)`, 'SUCCESS');
                        
                        if (source === 'speaker') {
                            displayStream.getVideoTracks().forEach(track => track.stop());
                            return displayStream;
                        }

                        if (source === 'both') {
                            try {
                                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                const combinedAudioContext = new AudioContext();
                                const destination = combinedAudioContext.createMediaStreamDestination();
                                
                                if (micStream && micStream.getAudioTracks().length > 0) {
                                    const micSource = combinedAudioContext.createMediaStreamSource(micStream);
                                    micSource.connect(destination);
                                    log('Mikrofon berhasil ditambahkan ke stream gabungan', 'SUCCESS');
                                }
                                
                                if (displayStream && displayStream.getAudioTracks().length > 0) {
                                    const displaySource = combinedAudioContext.createMediaStreamSource(displayStream);
                                    displaySource.connect(destination);
                                    log('Audio sistem berhasil ditambahkan ke stream gabungan', 'SUCCESS');
                                }
                                
                                displayStream.getVideoTracks().forEach(track => track.stop());
                                
                                return destination.stream;
                            } catch (micError) {
                                log(`Gagal mendapatkan mikrofon untuk mode 'both': ${micError.message}. Melanjutkan dengan audio sistem saja.`, 'WARNING');
                                displayStream.getVideoTracks().forEach(track => track.stop());
                                return displayStream;
                            }
                        }
                    } catch (displayError) {
                        log(`Error getting display media: ${displayError.message}`, 'ERROR');
                        
                        if (displayError.name === 'NotAllowedError') {
                            throw new Error('Izin untuk berbagi layar ditolak. Silakan coba lagi dan pastikan memberikan izin serta mencentang opsi "Share system audio".');
                        } else if (displayError.name === 'NotFoundError') {
                            throw new Error('Tidak ada sumber audio sistem yang ditemukan. Pastikan ada aplikasi yang sedang memutar audio dan pilih tab/jendela yang tepat.');
                        } else {
                            throw new Error(`Gagal mengakses audio sistem: ${displayError.message}`);
                        }
                    }
                }
            } catch (err) {
                log(`Error getting audio stream: ${err.message}`, 'ERROR');
                statusSpan.textContent = 'Gagal mendapatkan sumber audio.';
                alert(`Gagal merekam audio: ${err.message}\n\nTips:\n- Pastikan mencentang "Share system audio" saat memberikan izin\n- Pilih tab/jendela yang sedang memutar audio\n- Coba refresh halaman dan ulangi`);
                return null;
            }
        }
        
        function startTimer() {
            recordingIndicator.classList.remove('hidden');
            totalSeconds = 0;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                totalSeconds++;
                const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const secs = (totalSeconds % 60).toString().padStart(2, '0');
                timerSpan.textContent = `${minutes}:${secs}`;
            }, 1000);
        }

        async function handleRecordClick() {
            if (isContinuousRecording) {
                isContinuousRecording = false; 
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop(); 
                }
                clearTimeout(chunkTimer);
                clearInterval(timerInterval);
                recordButton.innerHTML = `<span>Mulai Rekam Suara</span>`;
                recordButton.classList.replace('bg-red-600', 'bg-blue-600');
                statusSpan.textContent = 'Sesi rekaman dihentikan.';
                log('Sesi rekaman berkelanjutan dihentikan oleh pengguna.', 'INFO');

            } else {
                const source = document.querySelector('input[name="audioSource"]:checked').value;
                if (source === 'mic' || source === 'both') {
                    const hasPermission = await ensurePermissions({audio: true});
                    if (!hasPermission) return;
                }
                
                const stream = await getAudioStream();
                if (!stream || stream.getAudioTracks().length === 0) {
                    log('Gagal mendapatkan sumber audio awal.', 'ERROR');
                    statusSpan.textContent = 'Gagal memulai rekaman.';
                    return;
                }
                
                activeStream = stream; 
                isContinuousRecording = true;
                chunkCount = 0;
                allRecordedBlobs = [];
                audioChunksList.innerHTML = '';
                
                startNewChunk(); 
            }
        }

        function startNewChunk() {
            if (!isContinuousRecording || !activeStream) return;
            
            chunkCount++;
            log(`Memulai rekaman bagian ke-${chunkCount}.`, 'INFO');
            statusSpan.textContent = `Merekam Bagian ${chunkCount}...`;
            statusLoader.classList.remove('hidden');


            audioChunks = [];
            
            try {
                mediaRecorder = new MediaRecorder(activeStream);
            } catch (error) {
                log(`Gagal membuat MediaRecorder: ${error.message}`, 'ERROR');
                statusSpan.textContent = 'Browser tidak mendukung perekaman.';
                isContinuousRecording = false;
                recordButton.innerHTML = `<span>Mulai Rekam Suara</span>`;
                recordButton.classList.replace('bg-red-600', 'bg-blue-600');
                return;
            }

            mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
            
            mediaRecorder.onstop = () => {
                const duration = timerSpan.textContent;
                if (audioChunks.length > 0) {
                    const recordedBlob = new Blob(audioChunks, { type: audioChunks[0].type || 'audio/webm' });
                    const filename = `${generateBaseFilename()}_bagian_${chunkCount}.webm`;
                    const blobUrl = URL.createObjectURL(recordedBlob);
                    
                    allRecordedBlobs.push({
                        blob: recordedBlob,
                        filename: filename,
                        url: blobUrl,
                        duration: duration,
                        partNumber: chunkCount,
                        status: 'transcribing' // === PERUBAHAN DI SINI: Status awal ===
                    });
                    
                    renderAudioChunks();
                    
                    if (recordedBlob.size > 0) {
                        log(`Mengirim bagian ke-${chunkCount} untuk transkripsi (di latar belakang).`, 'INFO');
                        transcribeAudio(recordedBlob, chunkCount); 
                    }
                }

                if (isContinuousRecording) {
                    startNewChunk();
                } else {
                    if (activeStream) activeStream.getTracks().forEach(track => track.stop());
                    log('Stream audio dihentikan.', 'INFO');
                    statusLoader.classList.add('hidden');
                }
            };
            
            try {
                mediaRecorder.start();
                recordButton.innerHTML = `<span>Hentikan Sesi Rekaman</span>`;
                recordButton.classList.replace('bg-blue-600', 'bg-red-600');
                if (chunkCount === 1) startTimer(); 
                
                chunkTimer = setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        log(`Batas waktu 20 menit untuk bagian ke-${chunkCount} tercapai. Menghentikan...`, 'INFO');
                        mediaRecorder.stop(); 
                    }
                }, MAX_CHUNK_DURATION);
            } catch (error) {
                log(`Error saat menjalankan mediaRecorder.start(): ${error.message}`, 'ERROR');
                statusSpan.textContent = 'Gagal memulai perekam.';
                isContinuousRecording = false;
                recordButton.innerHTML = `<span>Mulai Rekam Suara</span>`;
                recordButton.classList.replace('bg-red-600', 'bg-blue-600');
            }
        }
        
        // === PERUBAHAN DI SINI: Fungsi render diperbarui dengan logika status ===
        function renderAudioChunks() {
            audioChunksList.innerHTML = '';
            allRecordedBlobs.forEach(chunk => {
                const chunkEl = document.createElement('div');
                chunkEl.className = 'flex justify-between items-center bg-slate-100 p-2 rounded-md';
                
                let statusIcon = '';
                if (chunk.status === 'transcribing') {
                    statusIcon = `<div class="loader inline-loader !w-4 !h-4 !border-2 mr-2"></div>`;
                } else if (chunk.status === 'success') {
                    statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-green-500 mr-2" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>`;
                } else if (chunk.status === 'error') {
                    statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-red-500 mr-2" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>`;
                }

                chunkEl.innerHTML = `
                    <div class="flex items-center">
                        ${statusIcon}
                        <span class="font-mono text-slate-700">Bagian ${chunk.partNumber} (${chunk.duration})</span>
                    </div>
                    <a href="${chunk.url}" download="${chunk.filename}" class="text-indigo-600 hover:underline font-semibold text-xs ml-4">
                        Download
                    </a>
                `;
                audioChunksList.appendChild(chunkEl);
            });
        }
        // === AKHIR PERUBAHAN ===

        async function handleApiCall(url, options, context) {
            try {
                const response = await fetch(url, options);
                const responseText = await response.text(); 
                if (!response.ok) {
                    let errorJson;
                    try {
                        errorJson = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText);
                    }
                    throw new Error(errorJson.error || JSON.stringify(errorJson));
                }
                return JSON.parse(responseText);
            } catch (error) {
                log(`${context} failed: ${error.message}`, 'ERROR');
                statusSpan.textContent = `Gagal ${context}.`;
                throw error;
            }
        }

        // === PERUBAHAN DI SINI: Fungsi transcribe diperbarui untuk update status ===
        async function transcribeAudio(audioBlob, partNumber) {
            const formData = new FormData();
            formData.append('file', audioBlob, `recording_part_${partNumber}.webm`);
            
            const chunk = allRecordedBlobs.find(c => c.partNumber === partNumber);

            try {
                const result = await handleApiCall(`${BACKEND_URL}/api/transcribe`, { method: 'POST', body: formData }, 'Transcription');
                if (result.error) throw new Error(result.error);
                updateTranscript(result, `Suara (Bagian ${partNumber})`);
                log(`Transkripsi bagian ke-${partNumber} berhasil.`, 'SUCCESS');
                if(chunk) chunk.status = 'success';
            } catch (error) {
                 log(`Transkripsi bagian ke-${partNumber} gagal: ${error.message}`, 'ERROR');
                 if(chunk) chunk.status = 'error';
            } finally {
                 renderAudioChunks();
                 statusSpan.textContent = `Siap...`;
            }
        }
        // === AKHIR PERUBAHAN ===
        
        async function handleImageUpload(event, type) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const options = {
                maxSizeMB: 2.8,
                maxWidthOrHeight: 1920,
                useWebWorker: true,
            };

            for (const file of files) {
                log(`File asli: ${file.name}, ukuran: ${(file.size / 1024 / 1024).toFixed(2)} MB`, 'INFO');
                statusSpan.textContent = `Mengompres gambar ${file.name}...`;
                statusLoader.classList.remove('hidden');

                try {
                    const compressedFile = await window.imageCompression(file, options);
                    log(`File terkompresi: ${compressedFile.name}, ukuran: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`, 'SUCCESS');

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const newImage = { file: compressedFile, dataUrl: e.target.result, type, filename: compressedFile.name };
                        if (type === 'documentation') {
                            documentationImages.push(newImage);
                            renderDocPhotos();
                        } else {
                            screenshotImages.push(newImage);
                            renderScreenshotPhotos();
                            analyzeScreenshot(compressedFile);
                        }
                        saveState();
                    };
                    reader.readAsDataURL(compressedFile);
                } catch (error) {
                    log(`Gagal mengompres gambar: ${error.message}`, 'ERROR');
                    alert(`Terjadi kesalahan saat memproses gambar: ${file.name}. Mungkin file tersebut bukan format gambar yang didukung.`);
                } finally {
                    statusLoader.classList.add('hidden');
                    statusSpan.textContent = 'Siap...';
                }
            }
            event.target.value = ''; 
        }

        async function analyzeScreenshot(file) {
            statusSpan.textContent = 'Menganalisis gambar...';
            statusLoader.classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);
            try {
                const result = await handleApiCall(`${BACKEND_URL}/api/analyze-image`, { method: 'POST', body: formData }, 'Image analysis');
                if (result.error) throw new Error(result.error);
                const translationResult = result.choices[0]?.message?.content || { original: "Tidak dapat menganalisis gambar.", translated: "Tidak dapat menganalisis gambar." };
                updateTranscript(translationResult, "Gambar");
                statusSpan.textContent = 'Analisis berhasil.';
            } catch (error) {
            } finally {
                statusLoader.classList.add('hidden');
            }
        }

        function renderPhotos(container, imageArray, type) {
            container.innerHTML = '';
            imageArray.forEach((img, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-container';
                
                const imgEl = document.createElement('img');
                imgEl.src = img.dataUrl;
                imgEl.className = 'w-full h-16 object-cover rounded-md';

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'delete-photo-btn';
                deleteBtn.onclick = () => deletePhoto(index, type);

                wrapper.appendChild(imgEl);
                wrapper.appendChild(deleteBtn);
                container.appendChild(wrapper);
            });
        }

        function renderDocPhotos() { renderPhotos(docPhotosPreview, documentationImages, 'documentation'); }
        function renderScreenshotPhotos() { renderPhotos(screenshotPhotosPreview, screenshotImages, 'screenshot'); }
        
        function deletePhoto(index, type) {
            if (type === 'documentation') {
                documentationImages.splice(index, 1);
                renderDocPhotos();
            } else {
                screenshotImages.splice(index, 1);
                renderScreenshotPhotos();
            }
            saveState();
        }

        function handleManualNote() {
            const note = manualNote.value.trim();
            if (note) {
                updateTranscript({ original: note, translated: note }, "Manual");
                manualNote.value = "";
            }
        }

        async function openCamera(callback) {
            const hasPermission = await ensurePermissions({ video: true });
            if (!hasPermission) return;

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    cameraStream.srcObject = stream;
                    cameraModal.classList.replace('hidden', 'flex');
                    currentCameraCallback = callback;
                }).catch(err => log(`Camera error: ${err.message}`, 'ERROR'));
        }
        
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStream.videoWidth;
            canvas.height = cameraStream.videoHeight;
            canvas.getContext('2d').drawImage(cameraStream, 0, 0);
            canvas.toBlob(blob => {
                if (currentCameraCallback) currentCameraCallback(blob);
                closeCamera();
            }, 'image/jpeg');
        }

        function closeCamera() {
            if (cameraStream.srcObject) cameraStream.srcObject.getTracks().forEach(track => track.stop());
            cameraModal.classList.replace('flex', 'hidden');
        }

        async function captureScreenArea(type) {
            if (!navigator.mediaDevices.getDisplayMedia) {
                alert('Fitur ini tidak didukung di browser atau perangkat Anda.');
                return;
            }
            try {
                await showInstructionModalAndWait();
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                const videoTrack = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(videoTrack);
                const frame = await imageCapture.grabFrame();
                videoTrack.stop();

                const canvas = document.createElement('canvas');
                canvas.width = frame.width;
                canvas.height = frame.height;
                canvas.getContext('2d').drawImage(frame, 0, 0);
                canvas.toBlob(blob => {
                    const filename = `${generateBaseFilename()}_${type}_${Date.now()}.jpg`;
                    const file = new File([blob], filename, { type: 'image/jpeg' });
                    const event = { target: { files: [file] } };
                    handleImageUpload(event, type);
                }, 'image/jpeg');
            } catch (err) {
                log(`Screen capture error: ${err.message}`, 'ERROR');
            }
        }

        function generateBaseFilename() {
            const theme = document.getElementById('summaryTheme').value.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const name = (document.getElementById('meetingName').value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'acara');
            const dateInput = document.getElementById('meetingDate').value;
            let dateStr;
            if (dateInput) {
                const [year, month, day] = dateInput.split('-');
                dateStr = `${day}${month}${year}`;
            } else {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                const year = today.getFullYear();
                dateStr = `${day}${month}${year}`;
            }
            return `${name}_${theme}_${dateStr}`;
        }

        function cleanMarkdownForTxt(markdown) {
            return markdown.replace(/### (.*)/g, '$1\n').replace(/## (.*)/g, '$1\n').replace(/\*\*(.*?)\*\*/g, '$1').replace(/\* (.*)/g, '- $1');
        }

        function generateReportContent(format = 'txt') {
            const info = {
                name: document.getElementById('meetingName').value || "Acara Tanpa Judul",
                theme: document.getElementById('summaryTheme').options[document.getElementById('summaryTheme').selectedIndex].text,
                speaker: document.getElementById('speakerName').value || "Tidak disebutkan",
                date: document.getElementById('meetingDate').value,
                time: document.getElementById('meetingTime').value || "Tidak disebutkan",
                place: document.getElementById('meetingPlace').value || "Tidak disebutkan",
                notes: document.getElementById('meetingNotes').value || "Tidak ada",
            };
            let content = `Laporan Acara: ${info.name}\n\nINFORMASI ACARA\n-----------------\n- Tema: ${info.theme}\n- Pembicara: ${info.speaker}\n- Tanggal: ${info.date}\n- Jam: ${info.time}\n- Tempat: ${info.place}\n- Catatan: ${info.notes}\n\nRINGKASAN\n-----------------\n\n`;
            content += (format === 'txt') ? cleanMarkdownForTxt(summaryText) : `${summaryText}\n\n`;
            content += `TRANSKRIP LENGKAP\n-----------------\n\n${fullTranscript}`;
            return content;
        }
        
        function downloadAsFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadTxt() { downloadAsFile(`${generateBaseFilename()}.txt`, generateReportContent('txt'), 'text/plain;charset=utf-8;'); }
        function downloadMd() { downloadAsFile(`${generateBaseFilename()}.md`, generateReportContent('md'), 'text/markdown;charset=utf-8;'); }
        
        async function printReport() {
            log('Generating print view...', 'INFO');
            const button = document.getElementById('printButton');
            const originalText = button.querySelector('span').textContent;
            button.disabled = true;
            button.querySelector('span').textContent = 'Mempersiapkan...';
            
            try {
                // Generate the filename which will become the document title
                const filename = `${generateBaseFilename()}`;
        
                // Get the report content
                const reportTitle = document.getElementById('meetingName').value || "Laporan Acara";
                const summaryHtml = `<h1>Ringkasan</h1>${summaryOutput.innerHTML}`;
                // Format the raw transcript text nicely inside a <pre> tag
                const transcriptText = fullTranscript
                    .replace(/\[.*?\]:\n/g, (match) => `<strong>${match.slice(0, -2)}</strong>\n`) // Make headers bold
                    .replace(/---/g, '\n<hr>\n'); // Add horizontal rules
        
                const transcriptHtml = `<h2>Transkrip Lengkap</h2><pre style="white-space: pre-wrap; word-wrap: break-word;">${transcriptText}</pre>`;
        
                // Define styles for printing
                const printStyles = `
                    body { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 11pt; line-height: 1.5; color: #333; }
                    .container { width: 100%; margin: 0 auto; }
                    h1, h2, h3 { page-break-after: avoid; }
                    h1 { font-size: 24pt; border-bottom: 2px solid #eee; padding-bottom: 0.3em; margin-bottom: 0.5em;}
                    h2 { font-size: 18pt; border-bottom: 1px solid #eee; padding-bottom: 0.2em; margin-bottom: 0.5em;}
                    pre { background-color: #f4f4f4; padding: 1em; border-radius: 5px; page-break-inside: avoid; }
                    ul, ol { page-break-inside: avoid; }
                    @page {
                        margin: 1in;
                    }
                `;
        
                // Create a hidden iframe
                const iframe = document.createElement('iframe');
                iframe.style.position = 'absolute';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                document.body.appendChild(iframe);
        
                const iframeDoc = iframe.contentWindow.document;
        
                // Write the complete HTML document into the iframe
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html lang="id">
                        <head>
                            <meta charset="utf-8"/>
                            <title>${filename}</title>
                            <style>${printStyles}</style>
                        </head>
                        <body>
                            <div class="container">
                                <h1>${reportTitle}</h1>
                                ${summaryHtml}
                                ${transcriptHtml}
                            </div>
                        </body>
                    </html>
                `);
                iframeDoc.close();
                
                // Trigger the print dialog on the iframe's content
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
        
                // Clean up by removing the iframe
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 1000);

            } catch (error) {
                log(`Failed to prepare for printing: ${error.message}`, 'ERROR');
                alert('Gagal mempersiapkan dokumen untuk dicetak.');
            } finally {
                button.disabled = false;
                button.querySelector('span').textContent = originalText;
                const spinner = button.querySelector('.loader');
                if (spinner) {
                    button.removeChild(spinner);
                }
            }
        }

        function downloadAudio() {
            if (allRecordedBlobs.length > 0) {
                const combinedBlob = new Blob(allRecordedBlobs.map(c => c.blob), { type: 'audio/webm' });
                downloadAsFile(`${generateBaseFilename()}_full.webm`, combinedBlob, 'audio/webm');
            } else {
                alert('Tidak ada file suara yang direkam.');
            }
        }

        async function downloadPhotosAsZip() {
            const allImages = [...documentationImages, ...screenshotImages];
            if (allImages.length === 0) { alert('Tidak ada foto untuk diunduh.'); return; }
            const button = downloadPhotosBtn;
            const originalText = button.querySelector('span').textContent;
            button.disabled = true;
            button.querySelector('span').textContent = 'Mengompres...';
            const spinner = document.createElement('div');
            spinner.className = 'loader btn-spinner';
            button.prepend(spinner);
            const zipFilename = `${generateBaseFilename()}_fotos.zip`;
            const formData = new FormData();
            formData.append('zipFilename', zipFilename);
            
            allImages.forEach((img, index) => { 
                const extension = img.filename.split('.').pop() || 'jpg';
                const newFilename = `${generateBaseFilename()}_foto_${index + 1}.${extension}`;
                formData.append(`file${index}`, img.file, newFilename); 
            });

            try {
                const response = await fetch(`${BACKEND_URL}/api/generate-zip`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).error || 'Server error');
                const blob = await response.blob();
                downloadAsFile(zipFilename, blob, 'application/zip');
            } catch (error) {
                log(`Failed to generate ZIP: ${error.message}`, 'ERROR');
            } finally {
                button.disabled = false;
                button.querySelector('span').textContent = originalText;
                button.removeChild(spinner);
            }
        }

        function updateTranscript(result, source) {
            const original = result.original || (typeof result === 'string' ? result : '');
            const translated = result.translated || (typeof result === 'string' ? result : '');

            if (transcriptEmpty) { transcriptOutput.innerHTML = ""; transcriptEmpty = false; }
            
            let displayHTML = `<div class="mb-2 p-2 bg-slate-100 rounded"><strong>${source}:</strong><br>`;
            if (original && translated && original.trim().toLowerCase() !== translated.trim().toLowerCase() && source !== "Manual") {
                displayHTML += `<span class="text-xs text-slate-500">[ASLI]</span> ${original}<br><span class="text-xs text-green-600">[TERJEMAHAN]</span> ${translated}`;
            } else {
                displayHTML += translated; 
            }
            displayHTML += `</div>`;
            transcriptOutput.innerHTML += displayHTML;
            
            fullTranscript += `[${source} - Asli]:\n${original || 'N/A'}\n\n[${source} - Terjemahan]:\n${translated}\n\n---\n\n`;
            summarizeButton.disabled = false;
            saveState();
        }

        async function summarizeTranscript() {
            log('Summarization process started.');
            summarizeButton.disabled = true;
            summarizeLoader.classList.remove('hidden');
            const combinedContent = `${generateReportContent('txt')}`;
            try {
                const response = await fetch(`${BACKEND_URL}/api/summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: document.getElementById('summaryTheme').value, content: combinedContent })
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Summarization failed');
                const result = await response.json();
                summaryText = result.choices[0]?.message?.content;
                summaryOutput.innerHTML = markdownToHtml(summaryText);
                saveOptions.classList.remove('hidden');
                saveState();
            } catch (error) {
                log(error.message, 'ERROR');
            } finally {
                summarizeButton.disabled = false;
                summarizeLoader.classList.add('hidden');
            }
        }
        function markdownToHtml(markdown) {
            let html = markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            return html.replace(/<br><li>/g, '<li>').replace(/<\/li><br>/g, '</li>');
        }
        
        function startNewSession() {
            if (confirm("Apakah Anda yakin ingin memulai sesi baru? Semua data yang belum disimpan akan hilang.")) {
                localStorage.removeItem('asistenPintarState');
                window.location.reload();
            }
        }

        function setDefaultDateTime() {
            const now = new Date();
            
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;

            document.getElementById('meetingDate').value = today;
            document.getElementById('meetingTime').value = currentTime;
            log('Tanggal dan jam saat ini telah diatur.', 'INFO');
        }

        // Event listener untuk menampilkan/menyembunyikan peringatan
        document.querySelectorAll('input[name="audioSource"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'speaker' || this.value === 'both') {
                    speakerWarning.classList.remove('hidden');
                } else {
                    speakerWarning.classList.add('hidden');
                }
            });
        });

        // --- ALL EVENT LISTENERS ---
        newSessionButton.addEventListener('click', startNewSession);
        recordButton.addEventListener('click', handleRecordClick);
        addNoteButton.addEventListener('click', handleManualNote);
        takeDocPhotoButton.addEventListener('click', () => openCamera(blob => {
            const filename = `${generateBaseFilename()}_doc_${Date.now()}.jpg`;
            const file = new File([blob], filename, { type: 'image/jpeg' });
            handleImageUpload({ target: { files: [file] } }, 'documentation');
        }));
        takeScreenshotButton.addEventListener('click', () => openCamera(blob => {
            const filename = `${generateBaseFilename()}_ss_${Date.now()}.jpg`;
            const file = new File([blob], filename, { type: 'image/jpeg' });
            handleImageUpload({ target: { files: [file] } }, 'screenshot');
        }));
        uploadDocPhotoInput.addEventListener('change', (e) => handleImageUpload(e, 'documentation'));
        uploadScreenshotInput.addEventListener('change', (e) => handleImageUpload(e, 'screenshot'));
        takeDocScreenshotAreaButton.addEventListener('click', () => captureScreenArea('documentation'));
        takeNoteScreenshotAreaButton.addEventListener('click', () => captureScreenArea('screenshot'));
        captureButton.addEventListener('click', captureImage);
        downloadTxtBtn.addEventListener('click', downloadTxt);
        downloadMdBtn.addEventListener('click', downloadMd);
        printButton.addEventListener('click', printReport);
        downloadAudioBtn.addEventListener('click', downloadAudio);
        downloadPhotosBtn.addEventListener('click', downloadPhotosAsZip);
        summarizeButton.addEventListener('click', summarizeTranscript);
        toggleLogButton.addEventListener('click', () => { logWrapper.classList.toggle('hidden'); });
        copyLogButton.addEventListener('click', () => {
            navigator.clipboard.writeText(logContainer.innerText);
            copyLogButton.textContent = 'Copied!';
            setTimeout(() => { copyLogButton.textContent = 'Copy Log'; }, 2000);
        });

        window.addEventListener('load', () => {
            log('Asisten Pintar initialized.');
            setDefaultDateTime(); 
            loadState();

            if (!navigator.mediaDevices.getDisplayMedia) {
                log('Mobile device or unsupported browser. Hiding speaker/screenshot options.', 'INFO');
                document.getElementById('audioSourceSpeakerLabel').classList.add('hidden');
                document.getElementById('audioSourceBothLabel').classList.add('hidden');
                takeDocScreenshotAreaButton.classList.add('hidden');
                takeNoteScreenshotAreaButton.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
