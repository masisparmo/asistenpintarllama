<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Pintar - Asisten Pencatat Notulen Powered by Llama Ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link rel="icon" href="/path/to/favicon.ico">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #cameraModal { background-color: rgba(0,0,0,0.6); }
        .btn-spinner { border-top-color: white !important; width: 20px !important; height: 20px !important; }
        .photo-container { position: relative; }
        .delete-photo-btn {
            position: absolute; top: -4px; right: -4px;
            background-color: rgba(239, 68, 68, 0.9); color: white;
            border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            border: 1px solid white; line-height: 1;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto p-6 md:p-8 max-w-6xl bg-white rounded-2xl shadow-2xl border border-slate-200">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Asisten Pintar</h1>
            <p class="text-slate-600 mt-2">Asisten Pencatat Pintar Powered by Llama Ai</p>
            <div class="mt-4 flex justify-center items-center space-x-4 text-sm">
                <a href="https://asistenpintarku.isparmo.com/about.html" target="_blank" class="font-semibold text-indigo-600 hover:underline">Tentang Aplikasi</a>
                <span class="text-slate-400">|</span>
                <a href="https://asistenpintarku.isparmo.com/help.html" target="_blank" class="font-semibold text-indigo-600 hover:underline">Bantuan</a>
            </div>
        </header>

        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Informasi Acara</h2>
            <div id="event-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="text" id="meetingName" placeholder="Nama Acara" class="p-2 border border-slate-300 rounded-lg">
                <select id="summaryTheme" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="meeting">Rapat</option>
                    <option value="lecture">Kelas / Kuliah</option>
                    <option value="seminar">Seminar</option>
                    <option value="discussion">Diskusi</option>
                    <option value="interview">Wawancara</option>
                    <option value="sermon">Kajian / Ceramah</option>
                    <option value="consultation">Sesi Konsultasi</option>
                    <option value="ideation">Pencatat Ide</option>
                </select>
                <input type="text" id="speakerName" placeholder="Pembicara (jika ada)" class="p-2 border border-slate-300 rounded-lg">
                <!-- [PERBAIKAN 1] Menambahkan class 'w-full' agar lebar input sama dengan yang lain -->
                <input type="date" id="meetingDate" class="p-2 border border-slate-300 rounded-lg w-full">
                <input type="time" id="meetingTime" class="p-2 border border-slate-300 rounded-lg w-full">
                <input type="text" id="meetingPlace" placeholder="Tempat" class="p-2 border border-slate-300 rounded-lg">
                <textarea id="meetingNotes" placeholder="Catatan Tambahan..." class="p-2 border border-slate-300 rounded-lg md:col-span-3" rows="1"></textarea>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                 <h3 class="text-lg font-semibold mb-2 text-slate-700">Dokumentasi Foto</h3>
                 <div class="flex flex-col sm:flex-row gap-2 mb-2">
                     <button id="takeDocPhotoButton" class="flex-1 bg-blue-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-600">Ambil Foto</button>
                     <button id="takeDocScreenshotAreaButton" class="flex-1 bg-cyan-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-cyan-600">Ambil Screenshot</button>
                     <label class="flex-1 bg-blue-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-600 text-center cursor-pointer">Upload Foto<input type="file" id="uploadDocPhoto" class="hidden" accept="image/*" multiple></label>
                 </div>
                 <div id="doc-photos-preview" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">1. Kumpulkan Catatan</h2>
                <div class="space-y-4">
                    <div class="border-b border-slate-200 pb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Pilih Sumber Suara:</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2">
                            <label class="flex items-center"><input type="radio" name="audioSource" value="mic" class="mr-2" checked> Mikrofon</label>
                            <label id="audioSourceSpeakerLabel" class="flex items-center"><input type="radio" name="audioSource" value="speaker" class="mr-2"> Speaker (Audio Sistem)</label>
                            <label id="audioSourceBothLabel" class="flex items-center"><input type="radio" name="audioSource" value="both" class="mr-2"> Keduanya</label>
                        </div>
                    </div>
                    <button id="recordButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center space-x-2 shadow-sm">
                        <span>Mulai Rekam Suara</span>
                    </button>
                    <div id="recording-indicator" class="text-center text-sm font-mono text-slate-700 hidden">
                        <span id="timer">00:00</span> | <span id="size-estimator">0.0 MB</span>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="takeScreenshotButton" class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700">Ambil Foto</button>
                        <button id="takeNoteScreenshotAreaButton" class="flex-1 bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700">Ambil Screenshot</button>
                        <!-- [PERBAIKAN 3] Mengubah teks tombol secara responsif -->
                        <label class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 text-center cursor-pointer">
                            <span class="md:hidden">Upload SS</span>
                            <span class="hidden md:inline">Upload Screenshot</span>
                            <input type="file" id="uploadScreenshot" class="hidden" accept="image/*" multiple>
                        </label>
                    </div>
                     <div id="screenshot-photos-preview" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
                    <div class="border-t border-slate-200 pt-4">
                        <textarea id="manualNote" class="w-full p-3 border border-slate-300 rounded-lg" rows="3" placeholder="Atau ketik catatan manual di sini..."></textarea>
                        <button id="addNoteButton" class="w-full mt-2 bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-700">Tambah Catatan Manual</button>
                    </div>
                </div>
                 <div class="mt-auto pt-4 text-center text-sm text-slate-600 h-5 flex items-center justify-center space-x-2">
                    <div id="status-loader" class="loader !w-4 !h-4 !border-2 hidden"></div>
                    <span id="status">Siap Merekam...</span>
                </div>
            </div>

            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">2. Gabungan Transkrip</h2>
                <div id="transcriptOutput" class="h-80 overflow-y-auto bg-white p-4 rounded-lg border border-slate-200 text-sm leading-relaxed flex-grow">
                    <p class="text-slate-400">Catatan dari suara, gambar, dan ketikan akan muncul di sini.</p>
                </div>
            </div>
        </div>

        <div class="text-center mb-6">
            <button id="summarizeButton" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 flex items-center justify-center space-x-3 disabled:bg-slate-400 disabled:cursor-not-allowed shadow-lg mx-auto" disabled>
                <span>Buat Ringkasan</span>
                <div id="summarizeLoader" class="loader hidden"></div>
            </button>
        </div>
        <div>
            <h2 class="text-2xl font-semibold mb-4 text-center text-slate-800">3. Hasil Ringkasan</h2>
            <div id="summaryOutput" class="bg-white p-6 rounded-xl border border-slate-200 min-h-[200px] prose max-w-none prose-headings:text-slate-700 prose-strong:text-slate-800">
                <p class="text-slate-500">Ringkasan akan muncul di sini.</p>
            </div>
        </div>
        
        <div id="saveOptions" class="mt-8 grid grid-cols-1 justify-center hidden">
            <div class="text-center bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h2 class="text-xl font-semibold mb-2 text-slate-800">Simpan Laporan</h2>
                <div class="flex justify-center items-center gap-4 flex-wrap">
                    <button id="downloadTxt" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan .txt</span></button>
                    <button id="downloadMd" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan .md</span></button>
                    <button id="downloadPdf" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan .pdf</span></button>
                    <button id="downloadAudio" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan Audio</span></button>
                    <button id="downloadPhotos" class="bg-slate-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-slate-800 flex items-center justify-center space-x-2"><span>Simpan Foto (.zip)</span></button>
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <div class="flex justify-end items-center mb-2 h-9">
                <button id="toggleLogButton" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Tampilkan/Sembunyikan Log Developer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-slate-600" viewBox="0 0 16 16">
                        <path d="M6 9a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 9zM3.854 4.146a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2z"/>
                        <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2zm12 1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h12z"/>
                    </svg>
                </button>
            </div>
            <div id="logWrapper" class="hidden">
                 <div id="logContainer" class="bg-slate-800 text-white font-mono text-xs p-4 rounded-lg h-40 overflow-y-auto mb-2"></div>
                 <button id="copyLogButton" class="bg-slate-200 text-slate-600 text-xs font-semibold py-1 px-3 rounded-md hover:bg-slate-300">Copy Log</button>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-sm text-slate-500 space-y-2">
            <div class="flex justify-center items-center space-x-4">
                <a href="https://asistenpintarku.isparmo.com/terms.html" target="_blank" class="hover:underline">Ketentuan Layanan</a>
                <span class="text-slate-400">|</span>
                <a href="https://asistenpintarku.isparmo.com/privacy.html" target="_blank" class="hover:underline">Kebijakan Privasi</a>
            </div>
            <p>Dibuat oleh <a href="https://github.com/masisparmo" target="_blank" class="font-semibold text-indigo-600 hover:underline">masisparmo</a> untuk Hackathon Meta-Hacktiv8 2025.</p>
        </footer>
    </div>

    <button id="newSessionButton" title="Mulai Sesi Baru" class="fixed bottom-6 right-6 bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
    </button>

    <!-- Modals -->
    <div id="cameraModal" class="fixed inset-0 z-50 items-center justify-center hidden flex">
        <div class="bg-white p-4 rounded-lg shadow-xl">
            <video id="camera-stream" class="rounded-md" autoplay playsinline></video>
            <button id="captureButton" class="w-full mt-4 bg-red-600 text-white font-bold py-2 rounded-lg">Ambil Gambar</button>
        </div>
    </div>
    
    <script type="module">
        // Ganti dengan URL Vercel Anda yang terakhir berhasil
        const BACKEND_URL = 'https://asistenpintarllama-7czrvjrcm-isparmos-projects.vercel.app'; 

        // --- DOM Elements ---
        const newSessionButton = document.getElementById('newSessionButton');
        const recordButton = document.getElementById('recordButton');
        const uploadScreenshotInput = document.getElementById('uploadScreenshot');
        const manualNote = document.getElementById('manualNote');
        const addNoteButton = document.getElementById('addNoteButton');
        const summarizeButton = document.getElementById('summarizeButton');
        const statusSpan = document.getElementById('status');
        const statusLoader = document.getElementById('status-loader');
        const transcriptOutput = document.getElementById('transcriptOutput');
        const summaryOutput = document.getElementById('summaryOutput');
        const summarizeLoader = document.getElementById('summarizeLoader');
        const saveOptions = document.getElementById('saveOptions');
        const downloadTxtBtn = document.getElementById('downloadTxt');
        const downloadMdBtn = document.getElementById('downloadMd');
        const downloadPdfBtn = document.getElementById('downloadPdf');
        const downloadAudioBtn = document.getElementById('downloadAudio');
        const downloadPhotosBtn = document.getElementById('downloadPhotos');
        const logContainer = document.getElementById('logContainer');
        const copyLogButton = document.getElementById('copyLogButton');
        const eventForm = document.getElementById('event-form');
        const recordingIndicator = document.getElementById('recording-indicator');
        const timerSpan = document.getElementById('timer');
        const sizeEstimatorSpan = document.getElementById('size-estimator');
        const takeDocPhotoButton = document.getElementById('takeDocPhotoButton');
        const uploadDocPhotoInput = document.getElementById('uploadDocPhoto');
        const docPhotosPreview = document.getElementById('doc-photos-preview');
        const screenshotPhotosPreview = document.getElementById('screenshot-photos-preview');
        const takeScreenshotButton = document.getElementById('takeScreenshotButton');
        const cameraModal = document.getElementById('cameraModal');
        const cameraStream = document.getElementById('camera-stream');
        const captureButton = document.getElementById('captureButton');
        const takeDocScreenshotAreaButton = document.getElementById('takeDocScreenshotAreaButton');
        const takeNoteScreenshotAreaButton = document.getElementById('takeNoteScreenshotAreaButton');
        const toggleLogButton = document.getElementById('toggleLogButton');
        const logWrapper = document.getElementById('logWrapper');
        
        // --- App State ---
        let isRecording = false, mediaRecorder, fullTranscript = "", summaryText = "", activeStream, audioContext, audioChunks = [], timerInterval = null;
        let transcriptEmpty = true;
        let documentationImages = [];
        let screenshotImages = [];
        let currentCameraCallback = null;
        let recordedAudioBlob = null;

        function saveState() {
            const state = {
                fullTranscript,
                transcriptHTML: transcriptOutput.innerHTML,
                summaryText,
                summaryHTML: summaryOutput.innerHTML,
                docImages: documentationImages.map(img => ({ dataUrl: img.dataUrl, filename: img.filename, type: img.type })),
                ssImages: screenshotImages.map(img => ({ dataUrl: img.dataUrl, filename: img.filename, type: img.type })),
            };
            localStorage.setItem('asistenPintarState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('asistenPintarState');
            if (savedState) {
                const state = JSON.parse(savedState);
                fullTranscript = state.fullTranscript || "";
                transcriptOutput.innerHTML = state.transcriptHTML || '<p class="text-slate-400">Catatan akan muncul di sini.</p>';
                summaryText = state.summaryText || "";
                summaryOutput.innerHTML = state.summaryHTML || '<p class="text-slate-500">Ringkasan akan muncul di sini.</p>';
                
                if (fullTranscript) {
                    transcriptEmpty = false;
                    summarizeButton.disabled = false;
                }
                if (summaryText) saveOptions.classList.remove('hidden');

                documentationImages = state.docImages.map(imgData => ({ ...imgData, file: dataURLtoFile(imgData.dataUrl, imgData.filename) }));
                screenshotImages = state.ssImages.map(imgData => ({ ...imgData, file: dataURLtoFile(imgData.dataUrl, imgData.filename) }));

                renderDocPhotos();
                renderScreenshotPhotos();
                log('Sesi sebelumnya berhasil dimuat.', 'SUCCESS');
            }
        }

        function dataURLtoFile(dataurl, filename) {
            let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        function log(message, level = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = level === 'SUCCESS' ? 'text-green-400' : level === 'ERROR' ? 'text-red-400' : level === 'WARN' ? 'text-yellow-400' : 'text-blue-400';
            logContainer.innerHTML += `<p><span class="text-slate-500">${timestamp}</span> <span class="${colorClass}">[${level}]</span> ${message}</p>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function ensurePermissions(constraints) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (err) {
                log(`Permission denied for ${JSON.stringify(constraints)}: ${err.message}`, 'ERROR');
                alert('Akses ditolak. Harap aktifkan izin di pengaturan browser Anda untuk menggunakan fitur ini.\n\nBiasanya dengan mengklik ikon gembok di sebelah alamat URL.');
                return false;
            }
        }

        async function getAudioStream() {
            log('Attempting to get audio stream...');
            const source = document.querySelector('input[name="audioSource"]:checked').value;
            let micStream, displayStream;
            try {
                if (source === 'mic' || source === 'both') micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                if (source === 'speaker' || source === 'both') displayStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

                if (source === 'mic') return micStream;
                if (source === 'speaker') {
                    displayStream.getVideoTracks().forEach(track => track.stop());
                    return displayStream;
                }
                if (source === 'both') {
                    const combinedAudioContext = new AudioContext();
                    const destination = combinedAudioContext.createMediaStreamDestination();
                    if (micStream && micStream.getAudioTracks().length > 0) {
                        const micSource = combinedAudioContext.createMediaStreamSource(micStream);
                        micSource.connect(destination);
                    }
                    if (displayStream && displayStream.getAudioTracks().length > 0) {
                        const displaySource = combinedAudioContext.createMediaStreamSource(displayStream);
                        displaySource.connect(destination);
                    }
                    const videoTracks = displayStream ? displayStream.getVideoTracks() : [];
                    return new MediaStream([...destination.stream.getAudioTracks(), ...videoTracks]);
                }
            } catch (err) {
                log(`Error getting audio stream: ${err.message}`, 'ERROR');
                return null;
            }
        }
        
        function startTimer(mimeType) {
            recordingIndicator.classList.remove('hidden');
            let seconds = 0;
            const bytesPerSecond = (mimeType && mimeType.includes('opus')) ? 16000 : 16000 * 2;
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerSpan.textContent = `${minutes}:${secs}`;
                const estimatedMB = (seconds * bytesPerSecond / (1024 * 1024));
                sizeEstimatorSpan.textContent = `${estimatedMB.toFixed(2)} MB`;

                if (estimatedMB >= 24 && isRecording) {
                    handleRecordClick();
                }
            }, 1000);
        }

        async function handleRecordClick() {
            if (isRecording) {
                if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            } else {
                const hasPermission = await ensurePermissions({audio: true});
                if (!hasPermission) return;

                recordedAudioBlob = null;
                activeStream = await getAudioStream();
                if (!activeStream) return;
                isRecording = true;
                audioChunks = [];
                const options = { mimeType: 'audio/webm; codecs=opus' };
                mediaRecorder = new MediaRecorder(activeStream, options);
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                mediaRecorder.onstop = () => {
                    isRecording = false;
                    clearInterval(timerInterval);
                    recordingIndicator.classList.add('hidden');
                    if (activeStream) activeStream.getTracks().forEach(track => track.stop());
                    recordedAudioBlob = new Blob(audioChunks, { type: options.mimeType });
                    recordButton.innerHTML = `<span>Mulai Rekam Suara</span>`;
                    recordButton.classList.replace('bg-red-600', 'bg-blue-600');
                    if (recordedAudioBlob.size > 0) transcribeAudio(recordedAudioBlob);
                };
                mediaRecorder.start();
                startTimer(options.mimeType);
                recordButton.innerHTML = `<span>Berhenti Rekam</span>`;
                recordButton.classList.replace('bg-blue-600', 'bg-red-600');
            }
        }

        async function handleApiCall(url, options, context) {
            try {
                const response = await fetch(url, options);
                const responseText = await response.text(); 
                if (!response.ok) {
                    let errorJson;
                    try {
                        errorJson = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText);
                    }
                    throw new Error(errorJson.error || JSON.stringify(errorJson));
                }
                return JSON.parse(responseText);
            } catch (error) {
                log(`${context} failed: ${error.message}`, 'ERROR');
                statusSpan.textContent = `Gagal ${context}.`;
                throw error;
            }
        }

        async function transcribeAudio(audioBlob) {
            statusSpan.textContent = 'Mentranskripsi...';
            statusLoader.classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', audioBlob, 'recording.webm');
            try {
                const result = await handleApiCall(`${BACKEND_URL}/api/transcribe`, { method: 'POST', body: formData }, 'Transcription');
                if (result.error) throw new Error(result.error);
                updateTranscript(result, "Suara");
                statusSpan.textContent = 'Transkripsi berhasil!';
            } catch (error) {
            } finally {
                statusLoader.classList.add('hidden');
            }
        }
        
        async function handleImageUpload(event, type) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const options = {
                maxSizeMB: 2.8,
                maxWidthOrHeight: 1920,
                useWebWorker: true,
            };

            for (const file of files) {
                log(`File asli: ${file.name}, ukuran: ${(file.size / 1024 / 1024).toFixed(2)} MB`, 'INFO');
                statusSpan.textContent = `Mengompres gambar ${file.name}...`;
                statusLoader.classList.remove('hidden');

                try {
                    const compressedFile = await window.imageCompression(file, options);
                    log(`File terkompresi: ${compressedFile.name}, ukuran: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`, 'SUCCESS');

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const newImage = { file: compressedFile, dataUrl: e.target.result, type, filename: compressedFile.name };
                        if (type === 'documentation') {
                            documentationImages.push(newImage);
                            renderDocPhotos();
                        } else {
                            screenshotImages.push(newImage);
                            renderScreenshotPhotos();
                            analyzeScreenshot(compressedFile);
                        }
                        saveState();
                    };
                    reader.readAsDataURL(compressedFile);
                } catch (error) {
                    log(`Gagal mengompres gambar: ${error.message}`, 'ERROR');
                    alert(`Terjadi kesalahan saat memproses gambar: ${file.name}. Mungkin file tersebut bukan format gambar yang didukung.`);
                } finally {
                    statusLoader.classList.add('hidden');
                    statusSpan.textContent = 'Siap...';
                }
            }
            event.target.value = ''; 
        }

        async function analyzeScreenshot(file) {
            statusSpan.textContent = 'Menganalisis gambar...';
            statusLoader.classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);
            try {
                const result = await handleApiCall(`${BACKEND_URL}/api/analyze-image`, { method: 'POST', body: formData }, 'Image analysis');
                if (result.error) throw new Error(result.error);
                const translationResult = result.choices[0]?.message?.content || { original: "Tidak dapat menganalisis gambar.", translated: "Tidak dapat menganalisis gambar." };
                updateTranscript(translationResult, "Gambar");
                statusSpan.textContent = 'Analisis berhasil.';
            } catch (error) {
            } finally {
                statusLoader.classList.add('hidden');
            }
        }

        function renderPhotos(container, imageArray, type) {
            container.innerHTML = '';
            imageArray.forEach((img, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-container';
                
                const imgEl = document.createElement('img');
                imgEl.src = img.dataUrl;
                imgEl.className = 'w-full h-16 object-cover rounded-md';

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'delete-photo-btn';
                deleteBtn.onclick = () => deletePhoto(index, type);

                wrapper.appendChild(imgEl);
                wrapper.appendChild(deleteBtn);
                container.appendChild(wrapper);
            });
        }

        function renderDocPhotos() { renderPhotos(docPhotosPreview, documentationImages, 'documentation'); }
        function renderScreenshotPhotos() { renderPhotos(screenshotPhotosPreview, screenshotImages, 'screenshot'); }
        
        function deletePhoto(index, type) {
            if (type === 'documentation') {
                documentationImages.splice(index, 1);
                renderDocPhotos();
            } else {
                screenshotImages.splice(index, 1);
                renderScreenshotPhotos();
            }
            saveState();
        }

        function handleManualNote() {
            const note = manualNote.value.trim();
            if (note) {
                updateTranscript({ original: note, translated: note }, "Manual");
                manualNote.value = "";
            }
        }

        async function openCamera(callback) {
            const hasPermission = await ensurePermissions({ video: true });
            if (!hasPermission) return;

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    cameraStream.srcObject = stream;
                    cameraModal.classList.replace('hidden', 'flex');
                    currentCameraCallback = callback;
                }).catch(err => log(`Camera error: ${err.message}`, 'ERROR'));
        }
        
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStream.videoWidth;
            canvas.height = cameraStream.videoHeight;
            canvas.getContext('2d').drawImage(cameraStream, 0, 0);
            canvas.toBlob(blob => {
                if (currentCameraCallback) currentCameraCallback(blob);
                closeCamera();
            }, 'image/jpeg');
        }

        function closeCamera() {
            if (cameraStream.srcObject) cameraStream.srcObject.getTracks().forEach(track => track.stop());
            cameraModal.classList.replace('flex', 'hidden');
        }

        async function captureScreenArea(type) {
            if (!navigator.mediaDevices.getDisplayMedia) {
                alert('Fitur ini tidak didukung di browser atau perangkat Anda.');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(videoTrack);
                const frame = await imageCapture.grabFrame();
                videoTrack.stop();

                const canvas = document.createElement('canvas');
                canvas.width = frame.width;
                canvas.height = frame.height;
                canvas.getContext('2d').drawImage(frame, 0, 0);
                canvas.toBlob(blob => {
                    const filename = `${generateBaseFilename()}_${type}_${Date.now()}.jpg`;
                    const file = new File([blob], filename, { type: 'image/jpeg' });
                    const event = { target: { files: [file] } };
                    handleImageUpload(event, type);
                }, 'image/jpeg');
            } catch (err) {
                log(`Screen capture error: ${err.message}`, 'ERROR');
            }
        }

        function generateBaseFilename() {
            const theme = document.getElementById('summaryTheme').value.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const name = (document.getElementById('meetingName').value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'acara');
            const dateInput = document.getElementById('meetingDate').value;
            let dateStr;
            if (dateInput) {
                const [year, month, day] = dateInput.split('-');
                dateStr = `${day}${month}${year}`;
            } else {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                dateStr = `${day}${month}${year}`;
            }
            return `${theme}_${name}_${dateStr}`;
        }

        function cleanMarkdownForTxt(markdown) {
            return markdown.replace(/### (.*)/g, '$1\n').replace(/## (.*)/g, '$1\n').replace(/\*\*(.*?)\*\*/g, '$1').replace(/\* (.*)/g, '- $1');
        }

        function generateReportContent(format = 'txt') {
            const info = {
                name: document.getElementById('meetingName').value || "Acara Tanpa Judul",
                theme: document.getElementById('summaryTheme').options[document.getElementById('summaryTheme').selectedIndex].text,
                speaker: document.getElementById('speakerName').value || "Tidak disebutkan",
                date: document.getElementById('meetingDate').value,
                time: document.getElementById('meetingTime').value || "Tidak disebutkan",
                place: document.getElementById('meetingPlace').value || "Tidak disebutkan",
                notes: document.getElementById('meetingNotes').value || "Tidak ada",
            };
            let content = `Laporan Acara: ${info.name}\n\nINFORMASI ACARA\n-----------------\n- Tema: ${info.theme}\n- Pembicara: ${info.speaker}\n- Tanggal: ${info.date}\n- Jam: ${info.time}\n- Tempat: ${info.place}\n- Catatan: ${info.notes}\n\nRINGKASAN\n-----------------\n\n`;
            content += (format === 'txt') ? cleanMarkdownForTxt(summaryText) : `${summaryText}\n\n`;
            content += `TRANSKRIP LENGKAP\n-----------------\n\n${fullTranscript}`;
            return content;
        }
        
        function downloadAsFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadTxt() { downloadAsFile(`${generateBaseFilename()}.txt`, generateReportContent('txt'), 'text/plain;charset=utf-8;'); }
        function downloadMd() { downloadAsFile(`${generateBaseFilename()}.md`, generateReportContent('md'), 'text/markdown;charset=utf-8;'); }
        
        async function downloadPdf() {
            const button = downloadPdfBtn;
            const originalText = button.querySelector('span').textContent;
            button.disabled = true;
            button.querySelector('span').textContent = 'Membuat...';
            const spinner = document.createElement('div');
            spinner.className = 'loader btn-spinner';
            button.prepend(spinner);
            const filename = `${generateBaseFilename()}.pdf`;
            try {
                const response = await fetch(`${BACKEND_URL}/api/generate-pdf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportContent: generateReportContent('md'), filename: filename })
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Server error');
                const blob = await response.blob();
                downloadAsFile(filename, blob, 'application/pdf');
            } catch (error) {
                log(`Failed to generate PDF: ${error.message}`, 'ERROR');
            } finally {
                button.disabled = false;
                button.querySelector('span').textContent = originalText;
                button.removeChild(spinner);
            }
        }

        function downloadAudio() {
            if (recordedAudioBlob) {
                downloadAsFile(`${generateBaseFilename()}.webm`, recordedAudioBlob, 'audio/webm');
            } else {
                alert('Tidak ada file suara yang direkam.');
            }
        }

        async function downloadPhotosAsZip() {
            const allImages = [...documentationImages, ...screenshotImages];
            if (allImages.length === 0) { alert('Tidak ada foto untuk diunduh.'); return; }
            const button = downloadPhotosBtn;
            const originalText = button.querySelector('span').textContent;
            button.disabled = true;
            button.querySelector('span').textContent = 'Mengompres...';
            const spinner = document.createElement('div');
            spinner.className = 'loader btn-spinner';
            button.prepend(spinner);
            const zipFilename = `${generateBaseFilename()}_fotos.zip`;
            const formData = new FormData();
            formData.append('zipFilename', zipFilename);
            
            allImages.forEach((img, index) => { 
                const extension = img.filename.split('.').pop() || 'jpg';
                const newFilename = `${generateBaseFilename()}_foto_${index + 1}.${extension}`;
                formData.append(`file${index}`, img.file, newFilename); 
            });

            try {
                const response = await fetch(`${BACKEND_URL}/api/generate-zip`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).error || 'Server error');
                const blob = await response.blob();
                downloadAsFile(zipFilename, blob, 'application/zip');
            } catch (error) {
                log(`Failed to generate ZIP: ${error.message}`, 'ERROR');
            } finally {
                button.disabled = false;
                button.querySelector('span').textContent = originalText;
                button.removeChild(spinner);
            }
        }

        function updateTranscript(result, source) {
            const original = result.original || (typeof result === 'string' ? result : '');
            const translated = result.translated || (typeof result === 'string' ? result : '');

            if (transcriptEmpty) { transcriptOutput.innerHTML = ""; transcriptEmpty = false; }
            
            let displayHTML = `<div class="mb-2 p-2 bg-slate-100 rounded"><strong>${source}:</strong><br>`;
            if (original && translated && original.trim().toLowerCase() !== translated.trim().toLowerCase() && source !== "Manual") {
                displayHTML += `<span class="text-xs text-slate-500">[ASLI]</span> ${original}<br><span class="text-xs text-green-600">[TERJEMAHAN]</span> ${translated}`;
            } else {
                displayHTML += translated; 
            }
            displayHTML += `</div>`;
            transcriptOutput.innerHTML += displayHTML;
            
            fullTranscript += `[${source} - Asli]:\n${original || 'N/A'}\n\n[${source} - Terjemahan]:\n${translated}\n\n---\n\n`;
            summarizeButton.disabled = false;
            saveState();
        }

        async function summarizeTranscript() {
            log('Summarization process started.');
            summarizeButton.disabled = true;
            summarizeLoader.classList.remove('hidden');
            const combinedContent = `${generateReportContent('txt')}`;
            try {
                const response = await fetch(`${BACKEND_URL}/api/summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: document.getElementById('summaryTheme').value, content: combinedContent })
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Summarization failed');
                const result = await response.json();
                summaryText = result.choices[0]?.message?.content;
                summaryOutput.innerHTML = markdownToHtml(summaryText);
                saveOptions.classList.remove('hidden');
                saveState();
            } catch (error) {
                log(error.message, 'ERROR');
            } finally {
                summarizeButton.disabled = false;
                summarizeLoader.classList.add('hidden');
            }
        }
        function markdownToHtml(markdown) {
            let html = markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            return html.replace(/<br><li>/g, '<li>').replace(/<\/li><br>/g, '</li>');
        }
        
        function startNewSession() {
            if (confirm("Apakah Anda yakin ingin memulai sesi baru? Semua data yang belum disimpan akan hilang.")) {
                localStorage.removeItem('asistenPintarState');
                window.location.reload();
            }
        }

        // [PERBAIKAN 2] Fungsi untuk mengatur tanggal dan jam default
        function setDefaultDateTime() {
            const now = new Date();
            
            // Format YYYY-MM-DD untuk input tanggal
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            // Format HH:MM untuk input waktu
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;

            document.getElementById('meetingDate').value = today;
            document.getElementById('meetingTime').value = currentTime;
            log('Tanggal dan jam saat ini telah diatur.', 'INFO');
        }

        newSessionButton.addEventListener('click', startNewSession);
        recordButton.addEventListener('click', handleRecordClick);
        addNoteButton.addEventListener('click', handleManualNote);
        takeDocPhotoButton.addEventListener('click', () => openCamera(blob => {
            const filename = `${generateBaseFilename()}_doc_${Date.now()}.jpg`;
            const file = new File([blob], filename, { type: 'image/jpeg' });
            handleImageUpload({ target: { files: [file] } }, 'documentation');
        }));
        takeScreenshotButton.addEventListener('click', () => openCamera(blob => {
            const filename = `${generateBaseFilename()}_ss_${Date.now()}.jpg`;
            const file = new File([blob], filename, { type: 'image/jpeg' });
            handleImageUpload({ target: { files: [file] } }, 'screenshot');
        }));
        uploadDocPhotoInput.addEventListener('change', (e) => handleImageUpload(e, 'documentation'));
        uploadScreenshotInput.addEventListener('change', (e) => handleImageUpload(e, 'screenshot'));
        takeDocScreenshotAreaButton.addEventListener('click', () => captureScreenArea('documentation'));
        takeNoteScreenshotAreaButton.addEventListener('click', () => captureScreenArea('screenshot'));
        captureButton.addEventListener('click', captureImage);
        downloadTxtBtn.addEventListener('click', downloadTxt);
        downloadMdBtn.addEventListener('click', downloadMd);
        downloadPdfBtn.addEventListener('click', downloadPdf);
        downloadAudioBtn.addEventListener('click', downloadAudio);
        downloadPhotosBtn.addEventListener('click', downloadPhotosAsZip);
        summarizeButton.addEventListener('click', summarizeTranscript);
        toggleLogButton.addEventListener('click', () => { logWrapper.classList.toggle('hidden'); });
        copyLogButton.addEventListener('click', () => {
            navigator.clipboard.writeText(logContainer.innerText);
            copyLogButton.textContent = 'Copied!';
            setTimeout(() => { copyLogButton.textContent = 'Copy Log'; }, 2000);
        });

        window.addEventListener('load', () => {
            log('Asisten Pintar initialized.');
            setDefaultDateTime(); // Panggil fungsi untuk mengatur tanggal & jam
            loadState();

            if (!navigator.mediaDevices.getDisplayMedia) {
                log('Mobile device or unsupported browser. Hiding speaker/screenshot options.', 'INFO');
                document.getElementById('audioSourceSpeakerLabel').classList.add('hidden');
                document.getElementById('audioSourceBothLabel').classList.add('hidden');
                takeDocScreenshotAreaButton.classList.add('hidden');
                takeNoteScreenshotAreaButton.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
